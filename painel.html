<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ranking de Carteiras â€” Fundo da FamÃ­lia</title>
  <style>
    :root{
      --bg:#000000;
      --card:#0a0a0a;
      --grid:#0f0f0f;
      --text:#c7f9cc;
      --text-dim:#6ee7b7;
      --neon:#39ff14;
      --neon-soft: rgba(57,255,20,0.15);
      --danger:#ff6b6b;
      --muted:#2a2a2a;
    }
    *{
      box-sizing:border-box;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
    }
    body{
      margin:0; background:var(--bg); color:var(--text);
      letter-spacing:.2px;
    }
    .container{ max-width:1320px; margin:0 auto; padding:18px; }
    .header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      padding:12px 14px; background:linear-gradient(180deg, #020202, #000);
      border:1px solid #0f172a; border-radius:14px; box-shadow:0 0 0 1px #0b0b0b, 0 10px 30px rgba(0,0,0,.6);
    }
    h1{ margin:0; font-weight:700; font-size:20px; color:var(--neon); text-shadow:0 0 14px var(--neon-soft); }
    .muted{ color:#7ee2b8; opacity:.7; font-size:12px; margin-top:4px; }
    .badge{
      display:inline-flex; gap:6px; align-items:center; padding:6px 10px; font-size:11px;
      border:1px solid #113a19; background:#031306;
      border-radius:999px; color:var(--text-dim); box-shadow:0 0 10px rgba(0,0,0,.85);
    }
    .badge-dot{
      width:8px; height:8px; border-radius:999px; background:#22c55e; box-shadow:0 0 8px #22c55e;
    }
    .controls{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
    .select{
      background:#020712; border-radius:999px; border:1px solid #172554;
      padding:5px 12px; font-size:12px; color:var(--text-dim); display:flex; align-items:center; gap:6px;
    }
    select{
      background:transparent; border:none; outline:none; color:var(--text); font-size:12px;
    }
    button{
      cursor:pointer;
      border-radius:999px;
      border:1px solid #166534;
      background:radial-gradient(circle at top, #16a34a 0, #052e16 45%, #000 100%);
      padding:6px 14px; font-size:12px; color:#bbf7d0;
      box-shadow:0 0 16px rgba(22,163,74,.5);
    }
    button:hover{ filter:brightness(1.1); }
    .ticker{
      margin-top:10px; border-radius:999px; border:1px solid #064e3b;
      background:radial-gradient(circle at left, rgba(34,197,94,.22), rgba(0,0,0,0));
      padding:5px 10px; overflow:hidden; position:relative;
    }
    .ticker-track{
      display:inline-flex; gap:16px;
      white-space:nowrap;
      animation:ticker 28s linear infinite;
      font-size:11px; color:#a7f3d0;
    }
    .pill{
      padding:2px 10px; border-radius:999px; border:1px solid #0f766e;
      background:rgba(15,118,110,.15); font-size:11px;
    }
    @keyframes ticker{
      0%{ transform:translateX(0); }
      100%{ transform:translateX(-50%); }
    }

    table{ width:100%; border-collapse:collapse; margin-top:16px; font-size:13px; }
    th,td{ padding:8px 6px; border-bottom:1px solid #113a19; }
    thead tr{ background:radial-gradient(circle at top, rgba(15,118,110,.2), rgba(0,0,0,0)); }
    th{
      text-transform:uppercase; font-size:11px; color:var(--text-dim); letter-spacing:.05em;
      text-align:right;
    }
    th:first-child, td:first-child{ text-align:center; }
    th:nth-child(2), td:nth-child(2){ text-align:left; }
    tr:hover td{ background:rgba(57,255,20,0.02); }
    .rank{ color:var(--neon); font-weight:600; }
    .pos{ font-size:11px; opacity:.75; }
    .right{text-align:right;}
    .center{text-align:center;}
    .pos-up{ color:#22c55e; }
    .pos-down{ color:#f97316; }
    .text-bad{ color:var(--danger); }
    .footer{ font-size:11px; color:#7ee2b8; margin-top:8px; opacity:.7; }
    .chip{
      display:inline-flex; align-items:center; gap:4px; padding:2px 7px;
      border-radius:999px; font-size:11px;
    }
    .chip-pos{ color:#bbf7d0; border:1px solid #166534; background:rgba(22,101,52,.2); }
    .chip-neg{ color:#fecaca; border:1px solid #b91c1c; background:rgba(127,29,29,.18); }
    .small{ font-size:11px; opacity:.8; }

    @media (max-width:900px){
      .header{ flex-direction:column; align-items:flex-start; }
      .controls{ align-items:flex-start; }
      table{ font-size:12px; }
      th,td{ padding:6px 4px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>ðŸ“Š Ranking de Carteiras â€” Fundo Familiar</h1>
        <div class="muted">Privacidade ativa: exibindo apenas endereÃ§os. AtualizaÃ§Ã£o em tempo real.</div>
        <div class="ticker" role="marquee" aria-label="cotaÃ§Ã£o e destaques">
          <div class="ticker-track" id="tickerTrack"></div>
        </div>
      </div>
      <div class="controls">
        <span class="badge">
          <span class="badge-dot"></span>
          Online
        </span>
        <span class="badge" id="lastUpdate">Atualizando...</span>
        <div class="select">
          Ordenar:
          <select id="sortBy">
            <option value="saldoBRL">Saldo (BRL)</option>
            <option value="saldoBTC">Saldo (BTC)</option>
            <option value="pct24h">24h (%)</option>
            <option value="pct7d">7d (%)</option>
            <option value="pct30d">30d (%)</option>
            <option value="pct12m">12m (%)</option>
          </select>
        </div>
        <button id="refreshBtn">ðŸ”„ Atualizar agora</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Carteira</th>
          <th>Saldo (BRL)</th>
          <th>Saldo (BTC)</th>
          <th>% do Fundo</th>
          <th>24H</th>
          <th>24H (R$)</th>
          <th>7D</th>
          <th>7D (R$)</th>
          <th>30D</th>
          <th>30D (R$)</th>
          <th>12M</th>
          <th>12M (R$)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer">
      Taxa de atualizaÃ§Ã£o: 5s â€¢ Fonte: /fund/state e /fund/summary â€¢ % do fundo com base no valor total em BRL.
    </div>
  </div>

<script>
(function(){
  // AQUI Ã© o endereÃ§o que o GitHub vai chamar:
  const BACKEND = 'https://conscious-plaintiff-sales-guns.trycloudflare.com';

  const POLL_MS = 5000;

  let state = {
    wallets: [],
    sortBy: 'saldoBRL'
  };

  let priceBRLperBTC = 0;
  let fundTotalBRL = 0;

  function fmtBRL(v){
    if (!isFinite(v)) v = 0;
    return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:2});
  }
  function fmtBTC(v){
    if (!isFinite(v)) v = 0;
    return v.toFixed(6);
  }
  function fmtPct(v){
    if (!isFinite(v)) v = 0;
    const sign = v>0?'+':'';
    return sign+v.toFixed(2)+'%';
  }
  function shortAddr(a){
    const s = String(a||'');
    if (s.length<=10) return s;
    return s.slice(0,6)+'â€¦'+s.slice(-6);
  }

  async function fetchSummary(){
    try{
      const r = await fetch(`${BACKEND}/fund/summary`);
      const j = await r.json();
      if (!j || !j.ok){
        return;
      }
      priceBRLperBTC = Number(j.rates?.btcusdt || 0) * Number(j.rates?.usdtbrl || 0);
      fundTotalBRL = Number(j.fundTotalBRL || j.totalBRL || 0);
    }catch(e){
      console.error('Erro ao buscar /fund/summary', e);
    }
  }

  async function fetchWallets(){
    try{
      const r = await fetch(`${BACKEND}/fund/state`);
      const j = await r.json();
      if (!j || !j.ok || !Array.isArray(j.participants)) {
        return { wallets: [] };
      }

      const wallets = j.participants
        .filter(p => p.btcAddress && String(p.btcAddress).trim() !== '')
        .map(p => {
          const saldoBRL = Number(p.totalContributed || 0); // base: total aportado
          return {
            address: p.btcAddress,
            saldoBRL,
            pct24h: Number(p.pct24h || 0),
            pct7d:  Number(p.pct7d  || 0),
            pct30d: Number(p.pct30d || 0),
            pct12m: Number(p.pct12m || p.pctYear || p.pctAnual || 0)
          };
        });

      return { wallets };
    } catch(e){
      console.error('Erro ao buscar /fund/state', e);
      return { wallets: [] };
    }
  }

  function ensureBTC(wallet){
    if (wallet.saldoBTC && wallet.saldoBTC > 0) return wallet.saldoBTC;
    if (wallet.saldoBRL && priceBRLperBTC > 0) return wallet.saldoBRL / priceBRLperBTC;
    return 0;
  }

  function renderTicker(){
    const el = document.getElementById('tickerTrack');
    const w = state.wallets || [];
    const items = [];
    if (isFinite(fundTotalBRL)){
      items.push(`<span class="pill">Fundo â‰ˆ ${fmtBRL(fundTotalBRL)}</span>`);
    }
    if (w.length){
      const top = [...w].sort((a,b)=> (b.saldoBRL||0)-(a.saldoBRL||0)).slice(0,3);
      top.forEach((it,idx)=>{
        items.push(`<span class="pill">Top ${idx+1}: ${shortAddr(it.address)} â€” ${fmtBRL(it.saldoBRL||0)}</span>`);
      });
    }
    el.innerHTML = items.concat(items).join(' â€¢ ');
  }

  function render(){
    const tbody = document.getElementById('tbody');
    const sortBy = state.sortBy || 'saldoBRL';
    const wallets = state.wallets || [];

    const ranked = [...wallets].map(w => ({
      ...w,
      saldoBTC: ensureBTC(w),
      share: fundTotalBRL>0 ? (w.saldoBRL||0)/fundTotalBRL*100 : 0
    }));

    ranked.sort((a,b)=>{
      const av = a[sortBy] || 0;
      const bv = b[sortBy] || 0;
      return bv-av;
    });

    tbody.innerHTML = '';

    ranked.forEach((w,idx)=>{
      const saldo24h = (w.saldoBRL||0) * (w.pct24h||0) / 100;
      const saldo7d  = (w.saldoBRL||0) * (w.pct7d ||0) / 100;
      const saldo30d = (w.saldoBRL||0) * (w.pct30d||0) / 100;
      const saldo12m = (w.saldoBRL||0) * (w.pct12m||0) / 100;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="rank">${idx+1}</td>
        <td>${shortAddr(w.address)}</td>
        <td class="right">${fmtBRL(w.saldoBRL||0)}</td>
        <td class="right">${fmtBTC(w.saldoBTC||0)} BTC</td>
        <td class="right small">${fmtPct(w.share||0)}</td>
        <td class="right ${w.pct24h>=0 ? 'pos-up' : 'text-bad'}">${fmtPct(w.pct24h||0)}</td>
        <td class="right small ${saldo24h>=0 ? 'pos-up' : 'text-bad'}">${fmtBRL(saldo24h)}</td>
        <td class="right ${w.pct7d>=0 ? 'pos-up' : 'text-bad'}">${fmtPct(w.pct7d||0)}</td>
        <td class="right small ${saldo7d>=0 ? 'pos-up' : 'text-bad'}">${fmtBRL(saldo7d)}</td>
        <td class="right ${w.pct30d>=0 ? 'pos-up' : 'text-bad'}">${fmtPct(w.pct30d||0)}</td>
        <td class="right small ${saldo30d>=0 ? 'pos-up' : 'text-bad'}">${fmtBRL(saldo30d)}</td>
        <td class="right ${w.pct12m>=0 ? 'pos-up' : 'text-bad'}">${fmtPct(w.pct12m||0)}</td>
        <td class="right small ${saldo12m>=0 ? 'pos-up' : 'text-bad'}">${fmtBRL(saldo12m)}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('lastUpdate').textContent = 'Atualizado: ' + new Date().toLocaleString('pt-BR');
    renderTicker();
  }

  async function tick(){
    state.sortBy = document.getElementById('sortBy').value || 'saldoBRL';
    await fetchSummary();
    const { wallets } = await fetchWallets();
    state.wallets = wallets;
    render();
  }

  document.getElementById('refreshBtn').addEventListener('click', tick);
  document.getElementById('sortBy').addEventListener('change', render);

  tick();
  setInterval(tick, POLL_MS);
})();
</script>
</body>
</html>
