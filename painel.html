<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ranking de Carteiras â€” Fundo da FamÃ­lia</title>
  <style>
    :root{
      --bg:#000000;
      --card:#0a0a0a;
      --grid:#0f0f0f;
      --text:#c7f9cc;
      --text-dim:#6ee7b7;
      --neon:#39ff14;
      --neon-soft: rgba(57,255,20,0.15);
      --danger:#ff6b6b;
      --muted:#4b5563;
      --border:#1f2933;
    }
    *{
      box-sizing:border-box;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    }
    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(circle at top left,rgba(57,255,20,0.08),transparent 55%),
        radial-gradient(circle at bottom right,rgba(34,197,94,0.07),transparent 55%),
        #020617;
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 12px;
    }
    .container{
      width:100%;
      max-width:1120px;
      background:rgba(15,23,42,0.96);
      border-radius:20px;
      padding:20px 20px 16px;
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:
        0 22px 70px rgba(0,0,0,0.75),
        0 0 0 1px rgba(15,23,42,0.7);
      backdrop-filter:blur(16px);
    }
    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:10px;
    }
    h1{
      margin:0 0 4px;
      font-size:20px;
      letter-spacing:0.02em;
      display:flex;
      align-items:center;
      gap:8px;
    }
    h1 span.logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:26px;
      height:26px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0%,#bbf7d0,#4ade80);
      box-shadow:0 0 0 2px rgba(22,163,74,0.3),0 0 25px rgba(34,197,94,0.7);
      color:#052e16;
      font-size:14px;
      font-weight:800;
    }
    .subtitle{
      margin:0;
      font-size:12px;
      color:var(--text-dim);
    }
    .controls{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      font-size:12px;
    }
    .controls-top{
      display:flex;
      align-items:center;
      gap:8px;
    }
    label{
      color:var(--text-dim);
      font-size:11px;
    }
    select{
      background:#020617;
      border:1px solid rgba(148,163,184,0.6);
      color:var(--text);
      border-radius:999px;
      padding:4px 8px;
      font-size:11px;
      outline:none;
      cursor:pointer;
    }
    button{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      border:none;
      color:#ecfdf3;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      box-shadow:0 0 0 1px rgba(34,197,94,0.5),0 10px 22px rgba(22,163,74,0.4);
      font-weight:500;
    }
    button:hover{
      filter:brightness(1.05);
      transform:translateY(-0.5px);
    }
    button:active{
      transform:translateY(0.5px);
      box-shadow:0 8px 16px rgba(22,163,74,0.35);
    }
    .update-info{
      font-size:11px;
      color:#9ca3af;
    }
    .ticker{
      position:relative;
      overflow:hidden;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.55);
      background:radial-gradient(circle at 20% 0%,rgba(52,211,153,0.18),transparent 60%),rgba(15,23,42,0.98);
      padding:6px 0;
      margin-bottom:10px;
    }
    .ticker-inner{
      display:flex;
      align-items:center;
      gap:16px;
      white-space:nowrap;
      animation:marquee 26s linear infinite;
      padding-left:10px;
    }
    @keyframes marquee{
      0%{ transform:translateX(0); }
      100%{ transform:translateX(-50%); }
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(52,211,153,0.55);
      font-size:11px;
      color:#bbf7d0;
      box-shadow:0 0 0 1px rgba(15,23,42,0.85);
    }
    .pill::before{
      content:'â¬¤';
      font-size:7px;
      color:#4ade80;
      text-shadow:0 0 12px rgba(34,197,94,0.9);
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:6px;
      background:rgba(15,23,42,0.9);
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(30,64,175,0.7);
      box-shadow:
        0 14px 40px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.96);
    }
    thead{
      background:linear-gradient(135deg,rgba(15,23,42,0.7),rgba(17,24,39,0.88));
      border-bottom:1px solid rgba(30,64,175,0.9);
    }
    th,td{
      padding:8px 8px;
      font-size:12px;
      text-align:right;
      border-bottom:1px solid rgba(30,64,175,0.35);
    }
    th{
      font-weight:600;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:#9ca3af;
      background:radial-gradient(circle at top,rgba(30,64,175,0.35),transparent 60%);
    }
    tbody tr:last-child td{
      border-bottom:none;
    }
    th:nth-child(1),td:nth-child(1){ text-align:center; width:32px; }
    th:nth-child(2),td:nth-child(2){ text-align:left; }
    tr:hover td{
      background:rgba(30,64,175,0.24);
    }
    .rank{
      color:#60a5fa;
      font-weight:600;
      text-shadow:0 0 12px rgba(37,99,235,0.75);
    }
    .right{text-align:right;}
    .center{text-align:center;}
    .pos-up{ color:#4ade80; }
    .pos-down{ color:#fb923c; }
    .text-bad{ color:var(--danger); }
    .footer{
      font-size:11px;
      color:#9ca3af;
      margin-top:8px;
      opacity:.8;
      display:flex;
      justify-content:space-between;
      gap:6px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.9);
      color:#e5e7eb;
      background:rgba(15,23,42,0.9);
    }
    .chip span.emoji{
      font-size:13px;
    }
    .chip-pos{
      color:#bbf7d0;
      border:1px solid #166534;
      background:rgba(22,101,52,.25);
    }
    .chip-neg{
      color:#fecaca;
      border:1px solid #b91c1c;
      background:rgba(127,29,29,.2);
    }
    .small{
      font-size:11px;
      opacity:.8;
    }
    @media (max-width:900px){
      .header{
        flex-direction:column;
        align-items:flex-start;
      }
      .controls{
        align-items:flex-start;
      }
      table{
        font-size:12px;
      }
      th,td{
        padding:6px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>
          <span class="logo">â‚¿</span>
          Ranking de Carteiras â€” Fundo da FamÃ­lia
        </h1>
        <p class="subtitle">
          Painel em tempo real com base no backend do Money Tree.<br />
          50% do lucro Ã© distribuÃ­vel entre os participantes, proporcionalmente ao valor aportado.
        </p>
      </div>
      <div class="controls">
        <div class="controls-top">
          <label for="sortBy">Ordenar por:</label>
          <select id="sortBy">
            <option value="saldoBRL">Saldo (BRL)</option>
            <option value="saldoBTC">Saldo (BTC)</option>
            <option value="pct24h">24h (%)</option>
            <option value="pct7d">7d (%)</option>
            <option value="pct30d">30d (%)</option>
            <option value="pct12m">12m (%)</option>
            <option value="minhaCota50">Minha Cota (R$)</option>
          </select>
        </div>
        <button id="refreshBtn">ðŸ”„ Atualizar agora</button>
        <div class="update-info" id="lastUpdate">Atualizado: â€”</div>
      </div>
    </div>

    <div class="ticker">
      <div class="ticker-inner" id="tickerTrack">
        <!-- preenchido via JS -->
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Carteira</th>
          <th>Saldo (BRL)</th>
          <th>Saldo (BTC)</th>
          <th>% do Fundo</th>
          <th>24H</th>
          <th>24H (R$)</th>
          <th>7D</th>
          <th>7D (R$)</th>
          <th>30D</th>
          <th>30D (R$)</th>
          <th>12M</th>
          <th>12M (R$)</th>
          <th>50% do Lucro (R$)</th>
          <th>Minha Cota (R$)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer">
      <span>Taxa de atualizaÃ§Ã£o: 5s â€¢ Fonte: /fund/state e /fund/summary â€¢ % do fundo com base no valor total em BRL.</span>
      <span class="chip chip-pos"><span class="emoji">ðŸŒ±</span> 50% do lucro Ã© reinvestido no fundo, 50% Ã© distribuÃ­vel.</span>
    </div>
  </div>

<script>
(function(){
  // AQUI Ã© o endereÃ§o que o GitHub vai chamar:
  const BACKEND = 'https://conscious-plaintiff-sales-guns.trycloudflare.com';

  const POLL_MS = 5000;

  let state = {
    wallets: [],
    sortBy: 'saldoBRL'
  };

  let priceBRLperBTC = 0;
  let fundTotalBRL = 0;

  // lucro bruto do fundo e 50% distribuÃ­vel (regras do Money Tree)
  let grossProfitBRL = 0;
  let distributableBRL = 0;
  let totalContribBRL = 0;

  function fmtBRL(v){
    if (!isFinite(v)) v = 0;
    return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:2});
  }
  function fmtBTC(v){
    if (!isFinite(v)) v = 0;
    return v.toFixed(6);
  }
  function fmtPct(v){
    if (!isFinite(v)) v = 0;
    const sign = v>0?'+':'';
    return sign+v.toFixed(2)+'%';
  }
  function shortAddr(a){
    const s = String(a||'');
    if (s.length<=10) return s;
    return s.slice(0,6)+'â€¦'+s.slice(-6);
  }

  async function fetchSummary(){
    try{
      const r = await fetch(`${BACKEND}/fund/summary`);
      const j = await r.json();
      if (j && j.ok){
        priceBRLperBTC = Number(j.priceBRLperBTC || j.price || j.btcPriceBRL || 0);
        fundTotalBRL   = Number(j.totalBRL || j.total || 0);
      }
    } catch(e){
      console.error('Erro ao buscar /fund/summary', e);
    }
  }

  async function fetchWallets(){
    try{
      const r = await fetch(`${BACKEND}/fund/state`);
      const j = await r.json();
      if (!j || !j.ok || !Array.isArray(j.participants)) {
        return { wallets: [] };
      }

      const wallets = j.participants
        .filter(p => p.btcAddress && String(p.btcAddress).trim() !== '')
        .map(p => {
          const saldoBRL = Number(p.totalContributed || 0); // base: total aportado
          return {
            address: p.btcAddress,
            saldoBRL,
            pct24h: Number(p.pct24h || 0),
            pct7d:  Number(p.pct7d  || 0),
            pct30d: Number(p.pct30d || 0),
            pct12m: Number(p.pct12m || p.pctYear || p.pctAnual || 0)
          };
        });

      return { wallets };
    } catch(e){
      console.error('Erro ao buscar /fund/state', e);
      return { wallets: [] };
    }
  }

  function ensureBTC(wallet){
    if (wallet.saldoBTC && wallet.saldoBTC > 0) return wallet.saldoBTC;
    if (wallet.saldoBRL && priceBRLperBTC > 0) return wallet.saldoBRL / priceBRLperBTC;
    return 0;
  }

  // soma dos aportes em BRL (base para ratear os 50% de lucro)
  function sumContrib(wallets){
    return (wallets || []).reduce((acc, w) => acc + (Number(w.saldoBRL) || 0), 0);
  }

  function renderTicker(){
    const el = document.getElementById('tickerTrack');
    const w = state.wallets || [];
    const items = [];
    if (isFinite(fundTotalBRL)){
      items.push(`<span class="pill">Fundo â‰ˆ ${fmtBRL(fundTotalBRL)}</span>`);
    }
    if (isFinite(distributableBRL) && distributableBRL > 0){
      items.push(`<span class="pill">50% distribuÃ­vel â‰ˆ ${fmtBRL(distributableBRL)}</span>`);
    }
    if (w.length){
      const top = [...w].sort((a,b)=> (b.saldoBRL||0)-(a.saldoBRL||0)).slice(0,3);
      top.forEach((it,idx)=>{
        items.push(`<span class="pill">Top ${idx+1}: ${shortAddr(it.address)} â€” ${fmtBRL(it.saldoBRL||0)}</span>`);
      });
    }
    el.innerHTML = items.concat(items).join(' â€¢ ');
  }

  function render(){
    const tbody = document.getElementById('tbody');
    const sortBy = state.sortBy || 'saldoBRL';
    const wallets = state.wallets || [];

    // calcula base de rateio e lucro do fundo (>=0)
    totalContribBRL = sumContrib(wallets);
    grossProfitBRL = Math.max(fundTotalBRL - totalContribBRL, 0);
    distributableBRL = grossProfitBRL * 0.5;

    const ranked = [...wallets].map(w => {
      const saldoBRL = Number(w.saldoBRL || 0);
      const saldoBTC = ensureBTC(w);
      const share = fundTotalBRL>0 ? saldoBRL/fundTotalBRL*100 : 0;
      const baseShare = totalContribBRL>0 ? (saldoBRL/totalContribBRL) : 0;
      const minhaCota50 = distributableBRL * baseShare;

      return {
        ...w,
        saldoBRL,
        saldoBTC,
        share,
        baseShare,
        minhaCota50
      };
    });

    ranked.sort((a,b)=>{
      const av = a[sortBy] || 0;
      const bv = b[sortBy] || 0;
      return bv-av;
    });

    tbody.innerHTML = '';

    ranked.forEach((w,idx)=>{
      const saldo24h = (w.saldoBRL||0) * (w.pct24h||0) / 100;
      const saldo7d  = (w.saldoBRL||0) * (w.pct7d ||0) / 100;
      const saldo30d = (w.saldoBRL||0) * (w.pct30d||0) / 100;
      const saldo12m = (w.saldoBRL||0) * (w.pct12m||0) / 100;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="rank">${idx+1}</td>
        <td>${shortAddr(w.address)}</td>
        <td class="right">${fmtBRL(w.saldoBRL||0)}</td>
        <td class="right">${fmtBTC(w.saldoBTC||0)} BTC</td>
        <td class="right small">${fmtPct(w.share||0)}</td>
        <td class="right ${w.pct24h>=0 ? 'pos-up' : 'text-bad'}">${fmtPct(w.pct24h||0)}</td>
        <td class="right small ${saldo24h>=0 ? 'pos-up' : 'text-bad'}">${fmtBRL(saldo24h)}</td>
        <td class="right ${w.pct7d>=0 ? 'pos-up' : 'text-bad'}">${fmtPct(w.pct7d||0)}</td>
        <td class="right small ${saldo7d>=0 ? 'pos-up' : 'text-bad'}">${fmtBRL(saldo7d)}</td>
        <td class="right ${w.pct30d>=0 ? 'pos-up' : 'text-bad'}">${fmtPct(w.pct30d||0)}</td>
        <td class="right small ${saldo30d>=0 ? 'pos-up' : 'text-bad'}">${fmtBRL(saldo30d)}</td>
        <td class="right ${w.pct12m>=0 ? 'pos-up' : 'text-bad'}">${fmtPct(w.pct12m||0)}</td>
        <td class="right small ${saldo12m>=0 ? 'pos-up' : 'text-bad'}">${fmtBRL(saldo12m)}</td>
        <td class="right small">${fmtBRL(distributableBRL)}</td>
        <td class="right"><strong>${fmtBRL(w.minhaCota50 || 0)}</strong></td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('lastUpdate').textContent =
      'Atualizado: ' + new Date().toLocaleString('pt-BR');
    renderTicker();
  }

  async function tick(){
    state.sortBy = document.getElementById('sortBy').value || 'saldoBRL';
    await fetchSummary();
    const { wallets } = await fetchWallets();
    state.wallets = wallets;
    render();
  }

  document.getElementById('refreshBtn').addEventListener('click', tick);
  document.getElementById('sortBy').addEventListener('change', render);

  tick();
  setInterval(tick, POLL_MS);
})();
</script>
</body>
</html>
